# JWT

## JWT l√† g√¨?

JSON Web Token (JWT), l√† m·ªôt chu·∫©n m·ªü ([RFC 7519](https://tools.ietf.org/html/rfc7519 'RFC 7519')) gi√∫p truy·ªÅn t·∫£i th√¥ng tin d∆∞·ªõi d·∫°ng JSON.

**·ªû ƒë√¢y c√≥ m·ªôt l∆∞u √Ω l√†**: T·∫•t c·∫£ c√°c JWT ƒë·ªÅu l√† token, nh∆∞ng kh√¥ng ph·∫£i t·∫•t c·∫£ c√°c token ƒë·ªÅu l√† JWT.

S·∫µn ti·ªán n·∫øu b·∫°n th·∫Øc m·∫Øc **"Token l√† g√¨?"** th√¨ m√¨nh gi·∫£i th√≠ch ng·∫Øn g·ªçn nh∆∞ sau: **Token** l√† m·ªôt chu·ªói k√Ω t·ª± ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ ƒë·∫°i di·ªán cho m·ªôt ƒë·ªëi t∆∞·ª£ng ho·∫∑c m·ªôt quy·ªÅn truy c·∫≠p n√†o ƒë√≥, v√≠ d·ª• nh∆∞ access token, refresh token, jwt... Token th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√°c h·ªá th·ªëng x√°c th·ª±c v√† ·ªßy quy·ªÅn ƒë·ªÉ ki·ªÉm so√°t quy·ªÅn truy c·∫≠p c·ªßa ng∆∞·ªùi d√πng ƒë·ªëi v·ªõi t√†i nguy√™n ho·∫∑c d·ªãch v·ª•.

B·ªüi v√¨ k√≠ch th∆∞·ªõc t∆∞∆°ng ƒë·ªëi nh·ªè, JWT c√≥ th·ªÉ ƒë∆∞·ª£c g·ª≠i qua URL, qua tham s·ªë POST, ho·∫∑c b√™n trong HTTP Header m√† kh√¥ng ·∫£nh h∆∞·ªüng nhi·ªÅu ƒë·∫øn t·ªëc ƒë·ªô request.

D∆∞·ªõi ƒë√¢y l√† m·ªôt JWT sau khi ƒë∆∞·ª£c encode v√† sign:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjQ0MTE4NDdhZmJkYjUxMmE1MmMwNTQ4IiwidHlwZSI6MCwiaWF0IjoxNjgyMDgyNTA0LCJleHAiOjE2OTA3MjI1MDR9.QjSI3gJZgDSEHz6eYkGKIQ6gYiiizg5C0NDbGbGxtWU
```

C√°i chu·ªói JWT tr√™n c√≥ c·∫•u tr√∫c g·ªìm ba ph·∫ßn, m·ªói ph·∫ßn ƒë∆∞·ª£c ph√¢n t√°ch b·ªüi d·∫•u ch·∫•m (.): **Header**, **Payload** v√† **Signature**.

1.  **Header**: Ph·∫ßn n√†y ch·ª©a th√¥ng tin v·ªÅ lo·∫°i token (th∆∞·ªùng l√† "JWT") v√† thu·∫≠t to√°n m√£ h√≥a ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o ch·ªØ k√Ω (v√≠ d·ª•: HMAC SHA256 ho·∫∑c RSA). Header sau ƒë√≥ ƒë∆∞·ª£c m√£ h√≥a d∆∞·ªõi d·∫°ng chu·ªói Base64Url. (Th·ª≠ decode Base64 c√°i chu·ªói `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9` n√†y ra th√¨ n√≥ s·∫Ω c√≥ d·∫°ng `'{"alg":"HS256","typ":"JWT"}'`)
2.  **Payload**: Ph·∫ßn n√†y ch·ª©a c√°c th√¥ng tin m√† ng∆∞·ªùi d√πng ƒë·ªãnh nghƒ©a. Payload c≈©ng ƒë∆∞·ª£c m√£ h√≥a d∆∞·ªõi d·∫°ng chu·ªói Base64Url.
3.  **Signature**: Ph·∫ßn n√†y ƒë∆∞·ª£c t·∫°o b·∫±ng c√°ch d√πng thu·∫≠t to√°n HMACSHA256 (c√°i n√†y c√≥ th·ªÉ thay ƒë·ªïi) v·ªõi n·ªôi dung l√† Base64 encoded Header + Base64 encoded Payload k·∫øt h·ª£p m·ªôt "secret key" (kh√≥a b√≠ m·∫≠t). Signature (Ch·ªØ k√Ω) gi√∫p ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn v√† b·∫£o m·∫≠t c·ªßa th√¥ng tin trong JWT (C√¥ng th·ª©c chi ti·∫øt nh√¨n xu·ªëng ph√≠a d∆∞·ªõi nh√©)

B·∫°n copy c√°i chu·ªói tr√™n v√† paste v√†o [jwt.io](https://jwt.io/?_gl=1*kz5l66*rollup_ga*MTk3NDIxOTQ3OC4xNjc4Nzg2NDAx*rollup_ga_F1G3E656YZ*MTY4MzU0MTY2My4yMC4xLjE2ODM1NDIxNzguNjAuMC4w&_ga=2.178841069.832851294.1683541664-1974219478.1678786401 'jwt.io') th√¨ s·∫Ω th·∫•y k·∫øt qu·∫£ nh∆∞ sau

HEADER:ALGORITHM & TOKEN TYPE

```
{
  "alg": "HS256",
  "typ": "JWT"
}
```

PAYLOAD:DATA

```
{
  "user_id": "64411847afbdb512a52c0548",
  "type": 0,
  "iat": 1682082504,
  "exp": 1690722504
}
```

VERIFY SIGNATURE

```
HMACSHA256(base64UrlEncode(header) + '.' + base64UrlEncode(payload), secret_key)
```

L√∫c n√†y b·∫°n s·∫Ω th·∫Øc m·∫Øc "V·∫≠y t·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë·ªÅu bi·∫øt ƒë∆∞·ª£c th√¥ng tin **Header** v√† **Payload** c·ªßa c√°i JWT?"

**ƒê√∫ng r·ªìi**

Nh∆∞ng c√≥ m·ªôt ƒëi·ªÅu quan tr·ªçng l√† ch·ªâ c√≥ server m·ªõi bi·∫øt ƒë∆∞·ª£c **secret_key** ƒë·ªÉ t·∫°o ra **Signature**. V√¨ v·∫≠y ch·ªâ c√≥ server m·ªõi c√≥ th·ªÉ verify ƒë∆∞·ª£c c√°i JWT n√†y l√† do ch√≠nh server t·∫°o ra.

B·∫°n kh√¥ng tin ∆∞? T√¥i ƒë·ªë b·∫°n t·∫°o ra ƒë∆∞·ª£c JWT nh∆∞ tr√™n ƒë√≥, d√π b·∫°n bi·∫øt **Header** v√† **Payload** nh∆∞ng ƒë·ªÉ t·∫°o ra c√°i **Signature** th√¨ b·∫°n c·∫ßn ph·∫£i bi·∫øt ƒë∆∞·ª£c **secret_key** c·ªßa m√¨nh (nh√¨n c).

M·∫∑c ƒë·ªãnh th√¨ JWT d√πng thu·∫≠t to√°n HMACSHA256 n√™n ch√∫ng ta y√™n t√¢m r·∫±ng JWT c√≥ ƒë·ªô an to√†n c·ª±c cao v√† r·∫•t kh√≥ b·ªã l√†m gi·∫£.

Hi·ªÉu ƒë∆∞·ª£c JWT r·ªìi th√¨ ch√∫ng ta c√πng t√¨m hi·ªÉu v·ªÅ c√°ch s·ª≠ d·ª•ng JWT trong vi·ªác x√°c th·ª±c ng∆∞·ªùi d√πng nh√©.

## X√°c th·ª±c ng∆∞·ªùi d√πng v·ªõi Access Token

·ªû b√†i **Session Authentication** th√¨ ch√∫ng ta ƒë∆∞·ª£c h·ªçc r·∫±ng m·ªói request l√™n server th√¨ ƒë·ªÅu ph·∫£i k√®m theo session id ƒë·ªÉ server c√≥ th·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng n√†y l√† ai, c√≥ quy·ªÅn truy c·∫≠p t√†i nguy√™n hay kh√¥ng. C√°i session id n√†y ƒë∆∞·ª£c l∆∞u ·ªü c∆° s·ªü d·ªØ li·ªáu tr√™n server, m·ªói l·∫ßn request ph·∫£i m√≤ v√†o ƒë√≥ ki·ªÉm tra xem session id n√†y c√≥ trong ƒë√≥ kh√¥ng, r·∫•t m·∫•t th·ªùi gian.

### Access Token l√† g√¨

V·ªõi JWT th√¨ ng∆∞·ªùi ta ph√°t hi·ªán ra r·∫±ng ch·ªâ c·∫ßn t·∫°o 1 c√°i token JWT, l∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√†o nh∆∞ `user_id` hay `role`... r·ªìi g·ª≠i cho ng∆∞·ªùi d√πng, server kh√¥ng c·∫ßn ph·∫£i l∆∞u tr·ªØ c√°i token JWT n√†y l√†m g√¨. M·ªói l·∫ßn ng∆∞·ªùi d√πng request l√™n server th√¨ g·ª≠i c√°i token JWT n√†y l√™n, Server ch·ªâ c·∫ßn verify c√°i token JWT n√†y l√† bi·∫øt ƒë∆∞·ª£c ng∆∞·ªùi d√πng n√†y l√† ai, c√≥ quy·ªÅn truy c·∫≠p t√†i nguy√™n hay kh√¥ng.

> [!TIP]
> Ph∆∞∆°ng ph√°p d√πng token ƒë·ªÉ x√°c th·ª±c nh∆∞ th·∫ø n√†y ng∆∞·ªùi ta g·ªçi l√† **Token Based Authentication**.

B·∫°n s·ª£ ai ƒë√≥ c√≥ th·ªÉ l√†m gi·∫£ c√°i token JWT c·ªßa b·∫°n h·∫£?

**Kh√¥ng!** Kh√¥ng c√≥ ai c√≥ th·ªÉ t·∫°o ra ƒë∆∞·ª£c c√°i token JWT c·ªßa b·∫°n tr·ª´ khi h·ªç bi·∫øt c√°i **secret_key** c·ªßa b·∫°n, m√† c√°i **secret_key** n√†y b·∫°n l∆∞u tr·ªØ tr√™n server m√†, sao m√† bi·∫øt ƒë∆∞·ª£c (tr·ª´ b·∫°n b·ªã hack hay l·ª° tay l√†m l·ªô th√¨ ch·ªãu ü•≤).

V·∫≠y l√† ch√∫ng ta kh√¥ng c·∫ßn l∆∞u tr·ªØ c√°i JWT n√†y tr√™n server n·ªØa, ch·ªâ c·∫ßn client l∆∞u tr·ªØ l√† ƒë·ªß r·ªìi.

Ti·∫øt ki·ªám bi·∫øt bao nhi√™u l√† b·ªô nh·ªõ cho server, m√† c√≤n nhanh n·ªØa ch·ª© (v√¨ b·ªè qua b∆∞·ªõc ki·ªÉm tra trong c∆° s·ªü d·ªØ li·ªáu, c√°i b∆∞·ªõc verify jwt th√¨ n√≥ nhanh l·∫Øm)

V√† c√°i token ·ªü tr√™n ƒë·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng c√≥ quy·ªÅn truy c·∫≠p v√†o t√†i nguy√™n hay kh√¥ng ng∆∞·ªùi ta g·ªçi l√† **Access Token**.

Access Token l√† m·ªôt chu·ªói v·ªõi **b·∫•t k·ª≥ ƒë·ªãnh d·∫°ng n√†o**, nh∆∞ng ƒë·ªãnh d·∫°ng ph·ªï bi·∫øn nh·∫•t c·ªßa access token l√† JWT. Th∆∞·ªùng th√¨ c·∫•u tr√∫c data trong access token s·∫Ω theo [chu·∫©n n√†y](https://datatracker.ietf.org/doc/html/rfc9068 'chu·∫©n n√†y'). Tuy nhi√™n b·∫°n c√≥ th·ªÉ thay ƒë·ªïi theo √Ω th√≠ch, mi·ªÖn sao ph√π h·ª£p v·ªõi d·ª± √°n l√† ƒë∆∞·ª£c.

ƒê√¢y l√† m·ªôt chu·ªói access token m·∫´u

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNjQ0MTE4NDdhZmJkYjUxMmE1MmMwNTQ4IiwiaWF0IjoxNjgyMDgyNTA0LCJleHAiOjE2OTA3MjI1MDR9.tWlX7E7NPNftg37fXrdsXvkgEWB_8zaHIQmryAXzElY
```

ƒê√¢y l√† payload c·ªßa access token tr√™n

```
{
  "user_id": "64411847afbdb512a52c0548",
  "iat": 1682082504,
  "exp": 1690722504
}
```

Trong n√†y c√≥ 3 tr∆∞·ªùng quan tr·ªçng m√† server d√πng ƒë·ªÉ ki·ªÉm tra token li·ªáu c√≥ ƒë√∫ng ng∆∞·ªùi, hay c√≤n hi·ªáu l·ª±c kh√¥ng

- `user_id`: Ch√≠nh l√† id ƒë·ªãnh danh c·ªßa ng∆∞·ªùi d√πng, ƒë·ªÉ bi·∫øt token n√†y l√† c·ªßa ng∆∞·ªùi n√†o
- `iat`: Th·ªùi gian b·∫Øt ƒë·∫ßu token n√†y c√≥ hi·ªáu l·ª±c
- `exp`: Th·ªùi gian k·∫øt th√∫c token n√†y

T√πy t·ª´ng tr∆∞·ªùng h·ª£p m√† server c√≥ th·ªÉ th√™m c√°c tr∆∞·ªùng v√†o payload khi t·∫°o access token, kh√¥ng c·∫ßn c·ª©ng nh·∫Øc qu√°.

### Flow x√°c th·ª±c ng∆∞·ªùi d√πng v·ªõi Access Token

1.  Client g·ª≠i request v√†o t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá tr√™n server. N·∫øu client ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c, server tr·∫£ v·ªÅ l·ªói 401 Authorization. Client g·ª≠i username v√† password c·ªßa h·ªç cho server.
2.  Server x√°c minh th√¥ng tin x√°c th·ª±c ƒë∆∞·ª£c cung c·∫•p so v·ªõi c∆° s·ªü d·ªØ li·ªáu user. N·∫øu th√¥ng tin x√°c th·ª±c kh·ªõp, server t·∫°o ra m·ªôt JWT ch·ª©a payload l√† `user_id` (ho·∫∑c tr∆∞·ªùng n√†o ƒë√≥ ƒë·ªãnh danh ng∆∞·ªùi d√πng). JWT n√†y ƒë∆∞·ª£c g·ªçi l√† Access Token.
3.  Server g·ª≠i access token cho client.
4.  Client l∆∞u tr·ªØ access token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã (cookie, local storage,...).
5.  ƒê·ªëi v·ªõi c√°c y√™u c·∫ßu ti·∫øp theo, client g·ª≠i k√®m access token trong header c·ªßa request.
6.  Server verify access token b·∫±ng secret key ƒë·ªÉ ki·ªÉm tra access token c√≥ h·ª£p l·ªá kh√¥ng.
7.  N·∫øu h·ª£p l·ªá, server c·∫•p quy·ªÅn truy c·∫≠p v√†o t√†i nguy√™n ƒë∆∞·ª£c y√™u c·∫ßu. Khi ng∆∞·ªùi d√πng mu·ªën ƒëƒÉng xu·∫•t th√¨ ch·ªâ c·∫ßn x√≥a access token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã l√† ƒë∆∞·ª£c.
8.  Khi access token h·∫øt h·∫°n th√¨ server s·∫Ω t·ª´ ch·ªëi y√™u c·∫ßu c·ªßa client, client l√∫c n√†y s·∫Ω x√≥a access token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã v√† chuy·ªÉn sang tr·∫°ng th√°i b·ªã logout.

### V·∫•n ƒë·ªÅ c·ªßa Access Token

Nh∆∞ flow tr√™n th√¨ ch√∫ng ta kh√¥ng l∆∞u access token ·ªü tr√™n server, m√† l∆∞u ·ªü tr√™n client. ƒêi·ªÅu n√†y g·ªçi l√† stateless, t·ª©c l√† server kh√¥ng l∆∞u tr·ªØ tr·∫°ng th√°i n√†o c·ªßa ng∆∞·ªùi d√πng n√†o c·∫£.

Khuy·∫øt ƒëi·ªÉm c·ªßa n√≥ l√† ch√∫ng ta kh√¥ng th·ªÉ thu h·ªìi access token ƒë∆∞·ª£c. C√°c b·∫°n c√≥ th·ªÉ xem m·ªôt s·ªë v√≠ d·ª• d∆∞·ªõi ƒë√¢y.

**V√≠ d·ª• 1:** ·ªû server, ch√∫ng ta mu·ªën ch·ªß ƒë·ªông ƒëƒÉng xu·∫•t m·ªôt ng∆∞·ªùi d√πng th√¨ kh√¥ng ƒë∆∞·ª£c, v√¨ kh√¥ng c√≥ c√°ch n√†o x√≥a access token ·ªü thi·∫øt b·ªã client ƒë∆∞·ª£c.

**V√≠ d·ª• 2:** Client b·ªã hack d·∫´n ƒë·∫øn l√†m l·ªô access token, hacker l·∫•y ƒë∆∞·ª£c access token v√† c√≥ th·ªÉ truy c·∫≠p v√†o t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá. D√π cho server bi·∫øt ƒëi·ªÅu ƒë·∫•y nh∆∞ng kh√¥ng th·ªÉ t·ª´ ch·ªëi access token b·ªã hack ƒë√≥ ƒë∆∞·ª£c, v√¨ ch√∫ng ta ch·ªâ verify access token c√≥ ƒë√∫ng hay kh√¥ng ch·ª© kh√¥ng c√≥ c∆° ch·∫ø ki·ªÉm tra access token c√≥ n·∫±m trong danh s√°ch blacklist hay kh√¥ng.

V·ªõi v√≠ d·ª• th·ª© 2, ch√∫ng ta c√≥ th·ªÉ thi·∫øt l·∫≠p th·ªùi gian hi·ªáu l·ª±c c·ªßa access token ng·∫Øn, v√≠ d·ª• l√† 5 ph√∫t, th√¨ n·∫øu access token b·ªã l·ªô th√¨ hacker c≈©ng c√≥ √≠t th·ªùi gian ƒë·ªÉ x√¢m nh·∫≠p v√†o t√†i nguy√™n c·ªßa ch√∫ng ta h∆°n => gi·∫£m thi·ªÉu r·ªßi ro.

Nh∆∞ng m√† c√°ch n√†y kh√¥ng hay l·∫Øm, v√¨ n√≥ s·∫Ω l√†m cho ng∆∞·ªùi d√πng b·ªã logout v√† ph·∫£i login sau m·ªói 5 ph√∫t, r·∫•t kh√≥ ch·ªãu v·ªÅ tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.

L√∫c n√†y ng∆∞·ªùi ta m·ªõi nghƒ© ra ra m·ªôt c√°ch ƒë·ªÉ gi·∫£m thi·ªÉu nh·ªØng v·∫•n ƒë·ªÅ tr√™n, ƒë√≥ l√† s·ª≠ d·ª•ng th√™m Refresh Token.

## Refresh Token l√† g√¨?

Refresh Token l√† m·ªôt chu·ªói token kh√°c, ƒë∆∞·ª£c t·∫°o ra c√πng l√∫c v·ªõi Access Token. Refresh Token c√≥ th·ªùi gian hi·ªáu l·ª±c l√¢u h∆°n Access Token, v√≠ d·ª• nh∆∞ 1 tu·∫ßn, 1 th√°ng, 1 nƒÉm...

Flow x√°c th·ª±c v·ªõi access token v√† refresh token s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t nh∆∞ sau:

1.  Client g·ª≠i request v√†o t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá tr√™n server. N·∫øu client ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c, server tr·∫£ v·ªÅ l·ªói 401 Authorization. Client g·ª≠i username v√† password c·ªßa h·ªç cho server.
2.  Server x√°c minh th√¥ng tin x√°c th·ª±c ƒë∆∞·ª£c cung c·∫•p so v·ªõi c∆° s·ªü d·ªØ li·ªáu user. N·∫øu th√¥ng tin x√°c th·ª±c kh·ªõp, server t·∫°o ra **2 JWT kh√°c nhau** l√† Access Token v√† Refresh Token ch·ª©a payload l√† `user_id` (ho·∫∑c tr∆∞·ªùng n√†o ƒë√≥ ƒë·ªãnh danh ng∆∞·ªùi d√πng). Access Token c√≥ th·ªùi gian ng·∫Øn (c·ª° 5 ph√∫t). Refresh Token c√≥ th·ªùi gian d√†i h∆°n (c·ª° 1 nƒÉm). Refresh Token s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu, c√≤n Access Token th√¨ kh√¥ng.
3.  Server tr·∫£ v·ªÅ access token v√† refresh token cho client.
4.  Client l∆∞u tr·ªØ access token v√† refresh token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã (cookie, local storage,...).
5.  ƒê·ªëi v·ªõi c√°c y√™u c·∫ßu ti·∫øp theo, client g·ª≠i k√®m access token trong header c·ªßa request.
6.  Server verify access token b·∫±ng secret key ƒë·ªÉ ki·ªÉm tra access token c√≥ h·ª£p l·ªá kh√¥ng.
7.  N·∫øu h·ª£p l·ªá, server c·∫•p quy·ªÅn truy c·∫≠p v√†o t√†i nguy√™n ƒë∆∞·ª£c y√™u c·∫ßu.
8.  Khi access token h·∫øt h·∫°n, client g·ª≠i refresh token l√™n server ƒë·ªÉ l·∫•y access token m·ªõi.
9.  Server ki·ªÉm tra refresh token c√≥ h·ª£p l·ªá kh√¥ng, c√≥ t·ªìn t·∫°i trong c∆° s·ªü d·ªØ li·ªáu hay kh√¥ng. N·∫øu ok, server s·∫Ω **x√≥a refresh token c≈©** v√† **t·∫°o ra refresh token m·ªõi v·ªõi expire date nh∆∞ c≈©** (v√≠ d·ª• c√°i c≈© h·∫øt h·∫°n v√†o 5/10/2023 th√¨ c√°i m·ªõi c≈©ng h·∫øt h·∫°n v√†o 5/10/2023) l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu, t·∫°o th√™m access token m·ªõi.
10. Server tr·∫£ v·ªÅ access token m·ªõi v√† refresh token m·ªõi cho client.

11. Client l∆∞u tr·ªØ access token v√† refresh token m·ªõi ·ªü b·ªô nh·ªõ thi·∫øt b·ªã (cookie, local storage,...).

12. Client c√≥ th·ªÉ th·ª±c hi·ªán c√°c y√™u c·∫ßu ti·∫øp theo v·ªõi access token m·ªõi (qu√° tr√¨nh refresh token di·ªÖn ra ng·∫ßm n√™n client s·∫Ω kh√¥ng b·ªã logout).

13. Khi ng∆∞·ªùi d√πng mu·ªën ƒëƒÉng xu·∫•t th√¨ g·ªçi API logout, server s·∫Ω x√≥a refresh token trong c∆° s·ªü d·ªØ li·ªáu, ƒë·ªìng th·ªùi client ph·∫£i th·ª±c hi·ªán x√≥a access token v√† refresh token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã.

14. Khi refresh token h·∫øt h·∫°n (ho·∫∑c kh√¥ng h·ª£p l·ªá) th√¨ server s·∫Ω t·ª´ ch·ªëi y√™u c·∫ßu c·ªßa client, client l√∫c n√†y s·∫Ω x√≥a access token v√† refresh token ·ªü b·ªô nh·ªõ thi·∫øt b·ªã v√† chuy·ªÉn sang tr·∫°ng th√°i b·ªã logout.

### V·∫•n ƒë·ªÅ b·∫•t c·∫≠p gi·ªØa l√Ω thuy·∫øt v√† th·ª±c t·∫ø

Mong mu·ªën c·ªßa vi·ªác x√°c th·ª±c b·∫±ng JWT l√† stateless, nh∆∞ng ·ªü tr√™n c√°c b·∫°n ƒë·ªÉ √Ω m√¨nh l∆∞u refresh token v√†o c∆° s·ªü d·ªØ li·ªáu, ƒëi·ªÅu n√†y l√†m cho server ph·∫£i l∆∞u tr·ªØ tr·∫°ng th√°i c·ªßa ng∆∞·ªùi d√πng, t·ª©c l√† kh√¥ng c√≤n stateless n·ªØa.

Ch√∫ng ta mu·ªën b·∫£o m·∫≠t h∆°n th√¨ ch√∫ng ta kh√¥ng th·ªÉ c·ª©ng nh·∫Øc c·ª© stateless ƒë∆∞·ª£c, v·∫≠y n√™n k·∫øt h·ª£p stateless v√† stateful l·∫°i v·ªõi nhau c√≥ v·∫ª h·ª£p l√Ω h∆°n. Access Token th√¨ stateless, c√≤n Refresh Token th√¨ stateful.

ƒê√¢y l√† l√Ω do m√¨nh n√≥i c√≥ s·ª± m√¢u thu·∫´n gi·ªØa l√Ω thuy·∫øt v√† th·ª±c t·∫ø √°p d·ª•ng, kh√≥ m√† √°p d·ª•ng ho√†n to√†n stateless cho JWT trong th·ª±c t·∫ø ƒë∆∞·ª£c.

V√† c√≥ m·ªôt l√Ω do n·ªØa t·∫°i sao m√¨nh l∆∞u refresh token trong database ƒë√≥ l√† refresh token th√¨ c√≥ th·ªùi gian t·ªìn t·∫°i r·∫•t l√† l√¢u, n·∫øu bi·∫øt ai b·ªã l√¥ refresh token th√¨ m√¨nh c√≥ th·ªÉ x√≥a nh·ªØng c√°i refresh token c·ªßa user ƒë√≥ trong database, ƒëi·ªÅu n√†y s·∫Ω l√†m cho h·ªá th·ªëng an to√†n h∆°n.

T∆∞∆°ng t·ª± n·∫øu m√¨nh mu·ªën logout m·ªôt ng∆∞·ªùi d√πng n√†o ƒë√≥ th√¨ m√¨nh c≈©ng c√≥ th·ªÉ x√≥a refresh token c·ªßa ng∆∞·ªùi ƒë√≥ trong database. Sau kho·∫£n th·ªùi gian access token h·ªç h·∫øt h·∫°n th√¨ h·ªç th·ª±c hi·ªán refresh token s·∫Ω kh√¥ng th√†nh c√¥ng v√† h·ªç s·∫Ω b·ªã logout. C√≥ ƒëi·ªÅu l√† n√≥ kh√¥ng t·ª©c th·ªùi, m√† ph·∫£i ƒë·ª£i ƒë·∫øn khi access token h·∫øt h·∫°n th√¨ m·ªõi logout ƒë∆∞·ª£c.

Ch√∫ng ta c≈©ng c√≥ th·ªÉ c·∫£i thi·ªán th√™m b·∫±ng c√°ch cho th·ªùi gian h·∫øt h·∫°n access token ng·∫Øn l·∫°i v√† d√πng websocket ƒë·ªÉ th√¥ng b√°o cho client logout ngay l·∫≠p t·ª©c.

## Tr·∫£ l·ªùi m·ªôt v·∫°n c√¢u h·ªèi v√¨ sao v·ªÅ JWT

### T·∫°i sao l·∫°i t·∫°o m·ªôt refresh token m·ªõi khi ch√∫ng ta th·ª±c hi·ªán refresh token?

V√¨ n·∫øu refresh token b·ªã l·ªô, hacker c√≥ th·ªÉ s·ª≠ d·ª•ng n√≥ ƒë·ªÉ l·∫•y access token m·ªõi, ƒëi·ªÅu n√†y kh√° nguy hi·ªÉm. V·∫≠y n√™n d√π refresh token c√≥ th·ªùi gian t·ªìn t·∫°i r·∫•t l√¢u, nh∆∞ng c·ª© sau v√†i ph√∫t khi access token h·∫øt h·∫°n v√† th·ª±c hi·ªán refresh token th√¨ m√¨nh l·∫°i t·∫°o m·ªôt refresh token m·ªõi v√† x√≥a refresh token c≈©.

L∆∞u √Ω l√† c√°i Refresh Token m·ªõi v·∫´n **gi·ªØ nguy√™n ng√†y gi·ªù h·∫øt h·∫°n c·ªßa Refresh Token c≈©**. C√°i c≈© h·∫øt h·∫°n v√†o 5/10/2023 th√¨ c√°i m·ªõi c≈©ng h·∫øt h·∫°n v√†o 5/10/2023.

C√°i n√†y g·ªçi l√† **refresh token rotation**.

### L√†m th·∫ø n√†o ƒë·ªÉ revoke (thu h·ªìi) m·ªôt access token?

C√°c b·∫°n c√≥ th·ªÉ hi·ªÉu revoke ·ªü ƒë√¢y nghƒ©a l√† thu h·ªìi ho·∫∑c v√¥ hi·ªáu h√≥a

Nh∆∞ m√¨nh ƒë√£ n√≥i ·ªü tr√™n th√¨ access token ch√∫ng ta thi·∫øt k·∫ø n√≥ l√† stateless, n√™n kh√¥ng c√≥ c√°ch n√†o revoke ngay l·∫≠p t·ª©c **ƒë√∫ng nghƒ©a** ƒë∆∞·ª£c m√† ch√∫ng ta ph·∫£i ch·ªØa ch√°y th√¥ng qua websocket v√† revoke refresh token

C√≤n n·∫øu b·∫°n mu·ªën revoke ngay th√¨ b·∫°n ph·∫£i l∆∞u access token v√†o trong database, khi mu·ªën revoke th√¨ x√≥a n√≥ trong database l√† ƒë∆∞·ª£c, nh∆∞ng ƒëi·ªÅu n√†y s·∫Ω l√†m access token kh√¥ng c√≤n stateless n·ªØa.

### C√≥ khi n√†o c√≥ 2 JWT tr√πng nhau hay kh√¥ng?

C√≥! N·∫øu payload v√† secret key gi·ªëng nhau th√¨ 2 JWT s·∫Ω gi·ªëng nhau.

C√°c b·∫°n ƒë·ªÉ √Ω th√¨ trong payload JWT s·∫Ω c√≥ tr∆∞·ªùng `iat` (issued at) l√† th·ªùi gian t·∫°o ra JWT (ƒë√¢y l√† tr∆∞·ªùng m·∫∑c ƒë·ªãnh, tr·ª´ khi b·∫°n disable n√≥). V√† tr∆∞·ªùng `iat` n√≥ ƒë∆∞·ª£c t√≠nh b·∫±ng gi√¢y.

V·∫≠y n√™n n·∫øu ch√∫ng ta t·∫°o ra 2 JWT trong **c√πng 1 gi√¢y** th√¨ l√∫c th√¨ tr∆∞·ªùng `iat` c·ªßa 2 JWT n√†y s·∫Ω gi·ªëng nhau, c·ªông v·ªõi vi·ªác payload c√°c b·∫°n truy·ªÅn v√†o gi·ªëng nhau n·ªØa th√¨ s·∫Ω cho ra 2 JWT gi·ªëng nhau.

### ·ªû client th√¨ n√™n l∆∞u access token v√† refresh token ·ªü ƒë√¢u?

N·∫øu tr√¨nh duy·ªát th√¨ c√°c b·∫°n l∆∞u ·ªü cookie hay local storage ƒë·ªÅu ƒë∆∞·ª£c, m·ªói c√°i ƒë·ªÅu c√≥ ∆∞u nh∆∞·ª£c ƒëi·ªÉm ri√™ng. Nh∆∞ng cookie s·∫Ω c√≥ ph·∫ßn chi·∫øm ∆∞u th·∫ø h∆°n "1 t√≠ x√≠u" v·ªÅ ƒë·ªô b·∫£o m·∫≠t.

Chi ti·∫øt so s√°nh gi·ªØa local storage v√† cookie th√¨ m√¨nh s·∫Ω c√≥ m·ªôt b√†i vi·∫øt sau nh√©.

C√≤n n·∫øu l√† mobile app th√¨ c√°c b·∫°n l∆∞u ·ªü b·ªô nh·ªõ c·ªßa thi·∫øt b·ªã.

### G·ª≠i access token l√™n server nh∆∞ th·∫ø n√†o?

S·∫Ω c√≥ 2 tr∆∞·ªùng h·ª£p

- **L∆∞u cookie**: N√≥ s·∫Ω t·ª± ƒë·ªông g·ª≠i m·ªói khi request ƒë·∫øn server, kh√¥ng c·∫ßn quan t√¢m n√≥.
- **L∆∞u local storage**: C√°c b·∫°n th√™m v√†o header v·ªõi key l√† `Authorization` v√† gi√° tr·ªã l√† `Bearer <access_token>`.

### T·∫°i sao ph·∫£i th√™m Bearer v√†o tr∆∞·ªõc access token?

Th·ª±c ra b·∫°n th√™m hay kh√¥ng th√™m th√¨ ph·ª• thu·ªôc v√†o c√°ch server backend h·ªç code nh∆∞ th·∫ø n√†o.

ƒê·ªÉ m√† code api authentication chu·∫©n, th√¨ server n√™n y√™u c·∫ßu client ph·∫£i th√™m `Bearer` v√†o tr∆∞·ªõc access token. M·ª•c ƒë√≠ch ƒë·ªÉ n√≥i x√°c th·ª±c l√† "Bearer Authentication" (x√°c th·ª±c d·ª±a tr√™n token).

Bearer Authentication ƒë∆∞·ª£c ƒë·∫∑t t√™n d·ª±a tr√™n t·ª´ "bearer" c√≥ nghƒ©a l√† "ng∆∞·ªùi mang" - t·ª©c l√† b·∫•t k·ª≥ ai c√≥ token n√†y s·∫Ω ƒë∆∞·ª£c coi l√† ng∆∞·ªùi c√≥ quy·ªÅn truy c·∫≠p v√†o t√†i nguy√™n ƒë∆∞·ª£c y√™u c·∫ßu. ƒêi·ªÅu n√†y kh√°c v·ªõi c√°c ph∆∞∆°ng ph√°p x√°c th·ª±c kh√°c nh∆∞ "Basic Authentication" (x√°c th·ª±c c∆° b·∫£n) hay "Digest Authentication" (x√°c th·ª±c bƒÉm), c·∫ßn s·ª≠ d·ª•ng th√¥ng tin ƒëƒÉng nh·∫≠p ng∆∞·ªùi d√πng.

Vi·ªác th√™m "Bearer" v√†o tr∆∞·ªõc access token c√≥ m·ªôt s·ªë m·ª•c ƒë√≠ch ch√≠nh:

1.  **X√°c ƒë·ªãnh lo·∫°i x√°c th·ª±c**: Cung c·∫•p th√¥ng tin cho m√°y ch·ªß v·ªÅ ph∆∞∆°ng th·ª©c x√°c th·ª±c m√† ·ª©ng d·ª•ng kh√°ch mu·ªën s·ª≠ d·ª•ng. ƒêi·ªÅu n√†y gi√∫p m√°y ch·ªß x·ª≠ l√Ω y√™u c·∫ßu m·ªôt c√°ch ch√≠nh x√°c h∆°n.
2.  **T√≠nh chu·∫©n m·ª±c**: S·ª≠ d·ª•ng ti·ªÅn t·ªë "Bearer" gi√∫p ƒë·∫£m b·∫£o r·∫±ng c√°c ·ª©ng d·ª•ng v√† m√°y ch·ªß tu√¢n theo c√°c quy t·∫Øc chu·∫©n trong c√°ch s·ª≠ d·ª•ng v√† x·ª≠ l√Ω token.
3.  **D·ªÖ ph√¢n bi·ªát**: Th√™m "Bearer" gi√∫p ph√¢n bi·ªát gi·ªØa c√°c lo·∫°i token v√† x√°c th·ª±c kh√°c nhau. V√≠ d·ª•, n·∫øu m√°y ch·ªß h·ªó tr·ª£ nhi·ªÅu ph∆∞∆°ng th·ª©c x√°c th·ª±c, t·ª´ "Bearer" s·∫Ω gi√∫p m√°y ch·ªß x√°c ƒë·ªãnh lo·∫°i x√°c th·ª±c ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng d·ª±a tr√™n token.

Khi s·ª≠ d·ª•ng Bearer Authentication, ti√™u ƒë·ªÅ `Authorization` trong y√™u c·∫ßu HTTP s·∫Ω tr√¥ng nh∆∞ sau:

```
Authorization: Bearer your_access_token
```

### Khi t√¥i logout, t√¥i ch·ªâ c·∫ßn x√≥a access token v√† refresh token ·ªü b·ªô nh·ªõ c·ªßa client l√† ƒë∆∞·ª£c ch·ª©?

N·∫øu b·∫°n kh√¥ng g·ªçi api logout m√† ƒë∆°n thu·∫ßn ch·ªâ x√≥a access token v√† refresh token ·ªü b·ªô nh·ªõ c·ªßa client th√¨ b·∫°n v·∫´n s·∫Ω logout ƒë∆∞·ª£c, nh∆∞ng s·∫Ω kh√¥ng t·ªët cho h·ªá th·ªëng v·ªÅ m·∫∑t b·∫£o m·∫≠t. V√¨ refresh token v·∫´n c√≤n t·ªìn t·∫°i ·ªü database, n·∫øu hacker c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c refresh token c·ªßa b·∫°n th√¨ h·ªç v·∫´n c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c access token m·ªõi.

### T√¥i c√≥ nghe v·ªÅ OAuth 2.0, v·∫≠y n√≥ l√† g√¨?

OAuth 2.0 l√† m·ªôt giao th·ª©c x√°c th·ª±c v√† ·ªßy quy·ªÅn ti√™u chu·∫©n d√†nh cho ·ª©ng d·ª•ng web, di ƒë·ªông v√† m√°y t√≠nh ƒë·ªÉ b√†n. N√≥ cho ph√©p ·ª©ng d·ª•ng c·ªßa b√™n th·ª© ba (c√≤n g·ªçi l√† ·ª©ng d·ª•ng kh√°ch) truy c·∫≠p d·ªØ li·ªáu v√† t√†i nguy√™n c·ªßa ng∆∞·ªùi d√πng t·ª´ m·ªôt d·ªãch v·ª• nh√† cung c·∫•p (nh∆∞ Google, Facebook, Twitter, ...) m√† kh√¥ng c·∫ßn bi·∫øt th√¥ng tin ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng.

N√≥i ƒë∆°n gi·∫£n, n√≥ ch·ªâ l√† m·ªôt giao th·ª©c th√¥i, ·ª©ng d·ª•ng l√† l√†m m·∫•y ch·ª©c nƒÉng nh∆∞ ƒëƒÉng nh·∫≠p b·∫±ng google, facebook tr√™n ch√≠nh website ch√∫ng ta √° üòÇ.

V·ªÅ c√°i n√†y m√¨nh s·∫Ω c√≥ m·ªôt b√†i vi·∫øt ri√™ng lu√¥n, v·∫´n trong series n√†y nh√©.

## L∆∞u JWT token ·ªü local storage hay cookie?

C√≥ r·∫•t nhi·ªÅu tranh c√£i xung quanh vi·ªác l∆∞u token ·ªü ƒë√¢u? C√≥ ng∆∞·ªùi l∆∞u ·ªü Local Storage, c√≥ ng∆∞·ªùi l∆∞u ·ªü Cookie, c√≥ ng∆∞·ªùi l∆∞u ·ªü Session Storage, c√≥ ng∆∞·ªùi l∆∞u ·ªü RAM, c√≥ ng∆∞·ªùi l∆∞u ·ªü IndexedDB, c√≥ ng∆∞·ªùi l∆∞u ·ªü WebSQL, c√≥ ng∆∞·ªùi l∆∞u ·ªü ƒë√¢u ƒë√≥ kh√°c n·ªØa...

V·∫≠y th·ª±c s·ª± th√¨ l∆∞u ·ªü ƒë√¢u m·ªõi t·ªët?

B√†i vi·∫øt n√†y kh√¥ng √°p d·ª•ng cho m·ªçi d·ª± √°n, n√™n kh√¥ng c·∫ßn c·ª©ng nh·∫Øc ƒë√¢u nh√©

Oke b·∫Øt ƒë·∫ßu lu√¥n nh√© ü§ú

## L∆∞u Access Token ·ªü ƒë√¢u?

V·ªõi ƒëa s·ªë c√°c d·ª± √°n th√¨ m√¨nh s·∫Ω kh√¥ng ch·ªçn l∆∞u ·ªü Session Storage v√† Ram (l∆∞u trong 1 bi·∫øn c·ªßa JavaScript) b·ªüi v√¨

- N·∫øu l∆∞u ·ªü Session Storage th√¨ khi b·∫°n ƒë√≥ng tr√¨nh duy·ªát ƒëi m·ªü l·∫°i th√¨ session storage s·∫Ω b·ªã x√≥a => B·∫°n s·∫Ω ph·∫£i ƒëƒÉng nh·∫≠p l·∫°i.
- N·∫øu l∆∞u ·ªü RAM th√¨ b·∫°n s·∫Ω kh√¥ng th·ªÉ chia s·∫ª access token gi·ªØa c√°c tab tr√¨nh duy·ªát ƒë∆∞·ª£c, c≈©ng nh∆∞ ƒë√≥ng tab th√¨ access token s·∫Ω m·∫•t => B·∫°n s·∫Ω ph·∫£i ƒëƒÉng nh·∫≠p l·∫°i

R√µ r√†ng UX trong 2 tr∆∞·ªùng h·ª£p n√†y kh√¥ng t·ªët, tr·ª´ khi y√™u c·∫ßu d·ª± √°n c·ªßa c√°c b·∫°n l√† nh∆∞ v·∫≠y.

### L∆∞u ·ªü Local Storage

**∆Øu ƒëi·ªÉm**

- Nhanh, ti·ªán l·ª£i, kh√¥ng c·∫ßn ph·ª• thu·ªôc v√†o backend ƒë·ªÉ l∆∞u tr·ªØ.
- B·ªô nh·ªõ kh√° l·ªõn, th∆∞·ªùng l√† tr√™n **5MB**
- C√≥ th·ªÉ t·ª± quy·∫øt ƒë·ªãnh request n√†o c·∫ßn access token ƒë·ªÉ g·ª≠i l√™n server, request n√†o kh√¥ng c·∫ßn
- Kh√¥ng t·ª± ƒë·ªông g·ª≠i access token l√™n server, n√™n n·∫øu b·ªã t·∫•n c√¥ng CSRF th√¨ attacker kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c access token c·ªßa b·∫°n.

**Nh∆∞·ª£c ƒëi·ªÉm**

- N·∫øu b·ªã t·∫•n c√¥ng XSS th√¨ attacker c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c access token

M·ªôt website c√≥ th·ªÉ b·ªã t·∫•n c√¥ng XSS t·ª´ kh√° l√† nhi·ªÅu ngu·ªìn, v√≠ d·ª• nh∆∞: Do ch√≠nh code ch√∫ng ta vi·∫øt ra c√≥ l·ªó h·ªïng, do c√°c th∆∞ vi·ªán b√™n th·ª© 3 nh∆∞ React, Vue, Lodash,...

ƒê√¢y l√† c√°i l√Ω do duy nh·∫•t m√† m·ªôt s·ªë ng∆∞·ªùi anti localstorage m·ªôt c√°ch c·ª±c ƒëoan.

### L∆∞u ·ªü Cookie

**∆Øu ƒëi·ªÉm**

- Kh√¥ng th·ªÉ truy c·∫≠p ƒë∆∞·ª£c t·ª´ Javascript n·∫øu b·∫°n set thu·ªôc t√≠nh `httpOnly`, n√™n n·∫øu c√≥ b·ªã t·∫•n c√¥ng XSS th√¨ c≈©ng kh√¥ng l·∫•y ƒë∆∞·ª£c token c·ªßa b·∫°n.

**Nh∆∞·ª£c ƒëi·ªÉm**

C√≥ m·ªôt c√°i nh∆∞·ª£c ƒëi·ªÉm ƒë√≥ l√† c√≥ th·ªÉ b·ªã t·∫•n c√¥ng CSRF, nh∆∞ng b·∫°n c√≥ th·ªÉ gi·∫£i quy·∫øt b·∫±ng c√°ch th√™m m·ªôt s·ªë thu·ªôc t√≠nh cho cookie nh∆∞ `sameSite`, `secure`, `domain`, `path` ƒë·ªÉ gi·∫£m thi·ªÉu kh·∫£ nƒÉng b·ªã t·∫•n c√¥ng CSRF.

Ngo√†i ra n·∫øu d√πng c√°c framework SPA ng√†y nay n·ªØa th√¨ kh·∫£ nƒÉng b·ªã t·∫•n c√¥ng CSRF c≈©ng kh√¥ng c√≤n cao n·ªØa. V·∫≠y n√™n m√¨nh kh√¥ng cho ƒë√¢y l√† nh∆∞·ª£c ƒëi·ªÉm.

V·∫≠y theo m√¨nh nh∆∞·ª£c ƒëi·ªÉm khi d√πng Cookie l√†

- B·∫°n kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c c√°c payload c·ªßa JWT token, v√¨ JavaScript kh√¥ng truy c·∫≠p ƒë∆∞·ª£c v√†o cookie n·∫øu ch√∫ng ta set thu·ªôc t√≠nh `httpOnly` cho cookie.
- B·ªô nh·ªõ Cookie tr√™n tr√¨nh duy·ªát r·∫•t b√©, loanh quanh **4KB** th√¥i.
- D√πng cookie th√¨ ph√≠a backend s·∫Ω ph·∫£i x·ª≠ l√Ω th√™m m·ªôt s·ªë th·ª© nh∆∞: parse cookie, set cookie, ki·ªÉm tra request ƒë·∫øn server. N·∫øu ƒë·∫øn t·ª´ browser th√¨ parse cookie, n·∫øu ƒë·∫øn t·ª´ mobile app th√¨ d√πng header Authorization ƒë·ªÉ l·∫•y token...

**B·∫°n th·∫•y ƒë·∫•y, l∆∞u ·ªü ƒë√¢u c≈©ng c√≥ ∆∞u nh∆∞·ª£c ri√™ng.**

### T·∫°i sao ch√∫ng ta kh√¥ng k·∫øt h·ª£p c·∫£ 2 nh·ªâ?

Cookie ƒëem l·∫°i ∆∞u th·∫ø h∆°n 1 x√≠u v·ªÅ ƒë·ªô b·∫£o m·∫≠t khi so v·ªõi local storage, nh∆∞ng c≈©ng l√†m m·∫•t ƒëi c√°i hay c·ªßa JWT l√† c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c payload c·ªßa JWT token ·ªü client.

C√≥ nh·ªØng tr∆∞·ªùng h·ª£p ch√∫ng ta c·∫ßn ƒë·ªçc payload ƒë·ªÉ bi·∫øt th·ªùi gian h·∫øt h·∫°n c·ªßa token ch·∫≥ng h·∫°n, nh∆∞ng kh√¥ng l·∫•y ƒë∆∞·ª£c access token ·ªü trong cookie c≈©ng kh√° l√† kh√≥ ch·ªãu.

Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y th√¨ ch√∫ng ta c√≥ th·ªÉ chia access token l√†m 2 ph·∫ßn:

- **Header.Payload** th√¨ l∆∞u ·ªü local storage
- **Signature** th√¨ l∆∞u ·ªü cookie

Khi g·ª≠i l√™n server th√¨ server s·∫Ω gh√©p 2 ph·∫ßn n√†y l·∫°i th√†nh 1 v√† ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa token.

Nh∆∞ v·∫≠y th√¨ client c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c payload JWT v√† c≈©ng gi·ªØ l·∫°i ∆∞u ƒëi·ªÉm c·ªßa vi·ªác l∆∞u ·ªü Cookie.

### V·∫≠y th√¨ kh√¥ng n√™n l∆∞u token ·ªü Local Storage √†?

ƒê√¢u ƒë√≥ b·∫°n s·∫Ω g·∫∑p nh·ªØng b√†i nh∆∞ [Please Stop Using Local Storage](https://dev.to/rdegges/please-stop-using-local-storage-1i04 'Please Stop Using Local Storage') ho·∫∑c [LocalStorage vs Cookies: All You Need To Know About Storing JWT Tokens Securely in The Front-End](https://dev.to/cotter/localstorage-vs-cookies-all-you-need-to-know-about-storing-jwt-tokens-securely-in-the-front-end-15id 'LocalStorage vs Cookies: All You Need To Know About Storing JWT Tokens Securely in The Front-End') l√†m b·∫°n hoang mang v√† c√≥ c√°i nh√¨n kh√¥ng t·ªët v·ªÅ Local Storage.

N·∫øu c√°c b·∫°n l∆∞·ªõt xu·ªëng ƒë·ªçc comment c√°c b√†i vi·∫øt tr√™n th√¨ v·∫´n c√≥ r·∫•t nhi·ªÅu √Ω ki·∫øn kh√¥ng ƒë·ªìng t√¨nh v·ªõi t√°c gi·∫£.

Ch√∫ng ta c·∫ßn l√†m r√µ th·∫ø n√†y, l∆∞u tr·ªØ access token ·ªü Cookie kh√¥ng gi√∫p ch√∫ng ta tr√°nh ƒë∆∞·ª£c t·∫•n c√¥ng XSS m√† khi b·ªã t·∫•n c√¥ng XSS th√¨ hacker kh√≥ l·∫•y ƒë∆∞·ª£c access token c·ªßa b·∫°n h∆°n th√¥i.

Nhi·ªÅu ng∆∞·ªùi kh√¥ng h√¨nh dung ra ƒë∆∞·ª£c m·ª©c ƒë·ªô thi·ªát h·∫°i khi b·ªã t·∫•n c√¥ng XSS n√≥ l·ªõn nh∆∞ th·∫ø n√†o.

M·ªôt website m√† b·ªã t·∫•n c√¥ng XSS nghƒ©a l√† web ƒë·∫•y toang, hacker c√≥ th·ªÉ l√†m ƒë∆∞·ª£c nhi·ªÅu vi·ªác nghi√™m tr·ªçng h∆°n l√† l·∫•y ƒë∆∞·ª£c access token c·ªßa b·∫°n. V√≠ d·ª•:

- ƒêi·ªÅu khi·ªÉn website c·ªßa b·∫°n ƒë·ªÉ l·ª´a ng∆∞·ªùi d√πng g·ª≠i ti·ªÅn v√†o t√†i kho·∫£n c·ªßa hacker
- Hi·ªÉn th·ªã popup y√™u c·∫ßu ng∆∞·ªùi d√πng nh·∫≠p username/password ƒë·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng

V·∫≠y n√™n l∆∞u token ·ªü Local Storage m√¨nh th·∫•y r·∫•t l√† b√¨nh th∆∞·ªùng, n√≥ ƒëem l·∫°i s·ª± ti·ªán l·ª£i cho c·∫£ ph√≠a Front-End l·∫´n Back-End, kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨ ph·∫£i anti n√≥ c·∫£.

Mu·ªën c√¢n b·∫±ng gi·ªØa Cookie v√† Local Storage th√¨ c√≥ th·ªÉ k·∫øt h·ª£p c·∫£ 2 nh∆∞ m√¨nh ƒë√£ n√≥i ·ªü tr√™n, r·ªìi m√£ h√≥a th√™m b·∫±ng m·ªôt thu·∫≠t to√°n n·ªØa ·ªü ph√≠a client cho tƒÉng ƒë·ªô kh√≥,...

N√≥i chung mu·ªën b·∫£o m·∫≠t h∆°n th√¨ c√≥ nhi·ªÅu c√°ch l·∫Øm, nh∆∞ng h√£y nghƒ© xem n√≥ c√≥ th·ª±c s·ª± c·∫ßn thi·∫øt hay kh√¥ng, li·ªáu n√≥ c√≥ ƒë√°ng ƒë·ªÉ b·ªè th·ªùi gian ra l√†m hay kh√¥ng.

√Ä x√≠u n·ªØa qu√™n, n·∫øu API ch·ªâ nh·∫≠n access token th√¥ng quan HTTP Header `Authorization` th√¨ l·∫°i th√™m 1 l√Ω do n·ªØa ƒë·ªÉ ch√∫ng ta l∆∞u token ·ªü Local Storage r·ªìi üòÉ

## T√≥m l·∫°i

- XSS l√† **game over**, b·∫•t k·ªÉ b·∫°n l∆∞u token ·ªü ƒë√¢u
- L∆∞u token ·ªü Local Storage hay Cookie ƒë·ªÅu ·ªïn, kh√¥ng c√≥ g√¨ ph·∫£i anti c·∫£.
- Mu·ªën c√¢n b·∫±ng gi·ªØa ∆∞u ƒëi·ªÉm c·ªßa c·∫£ 2 th√¨ c√≥ th·ªÉ k·∫øt h·ª£p c·∫£ 2.
- M√£ h√≥a th√™m 1 v√†i b∆∞·ªõc ·ªü client n·∫øu mu·ªën tƒÉng ƒë·ªô b·∫£o m·∫≠t.
